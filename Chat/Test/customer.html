<!-- The following line is essential for the "position: fixed" property to work correctly in IE -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>jquery.ui.chatbox</title>
    <link href="chatbox/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="chatbox/fonts/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="chatbox/jquery-ui-1.12.1.min.css" type="text/css" />
    <link type="text/css" href="chatbox/jquery.ui.chatbox.css" rel="stylesheet" />
    <link type="text/css" href="chatbox/chat.css" rel="stylesheet" />
    <script type="text/javascript" src="chatbox/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="chatbox/jquery-ui-1.12.1.min.js"></script>
    <script type="text/javascript" src="chatbox/jquery.ui.chatbox.js"></script>
    <script type="text/javascript" src="chatbox/bootstrap.min.js"></script>
    <script type="text/javascript" src="Scripts/js.cookie.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.3.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>
    <script type="text/javascript">
        $(function () {
            var chat = $.connection.chatHub;
            $.connection.hub.start();
            var box = null;

            loadChatWindow = function (name, email) {
                Cookies.set("name", name, { expires: 1 });
                Cookies.set("email", email, { expires: 1 });
                chat.server.populateCustomer(name, email);
                box = $("#chat_div").chatbox({
                    id: name,
                    user: { key: "value" },
                    title: name,
                    boxClosed: function (id) {
                        chat.server.customerEndsChat();
                    },
                    messageSent: function (id, user, msg) {
                        chat.server.send(id, msg);
                    }
                });
            };

             chat.client.showWaitingForAgent = function () {
                $("#chat_div")
                    .chatbox("option", "boxManager")
                    .addMsg("System", "Waiting for Agent...");
            };

            chat.client.showNoAgentAvailable = function () {
                $("#chat_div")
                    .chatbox("option", "boxManager")
                    .addMsg("System", "No Agents are available");

            };

            chat.client.showChatEndMessage = function () {
                $("#chat_div")
                    .chatbox("option", "boxManager")
                    .addMsg("System", "Chat has ended");
            };

            chat.client.showAgentAvailableMessage = function (name) {
                $("#chat_div")
                    .chatbox("option", "boxManager")
                    .addMsg("System", "Agent: " + name + " is in chat");
            };

            chat.client.enableChat = function () {

            };

            chat.client.removeCookie = function () {
                Cookies.set("name", null);
                Cookies.set("email", null);
            };

            isCookiePresent = function () {
                var cookiePresent = Cookies.get("name");
                return (
                    typeof (cookiePresent) !== 'undefined' &&
                    cookiePresent !== null);
            };

            $("#chat_min_button").click(function () {
                if ($(this).html() === "<i class=\"fa fa-minus-square\"></i>") {
                    $(this).html("<i class=\"fa fa-plus-square\"></i>");
                }
                else {
                    $(this).html("<i class=\"fa fa-minus-square\"></i>");
                }
        
                if (isCookiePresent()) {
                    var name = Cookies.get("name");
                    var email = Cookies.get("email");
                    loadChatWindow(name, email);
                    $("#chat_window").hide();
                }

                $("#chat_box")
                    .slideToggle();
            });

            chat.client.broadcastMessage = function (name, message) {
                var encodedName = $('<div />').text(name).html();
                var encodedMsg = $('<div />').text(message).html();
                $("#chat_div")
                    .chatbox("option", "boxManager")
                    .addMsg(encodedName, encodedMsg);
            };


            $("#btn").click(function (event, ui) {
                if (box) {
                    box
                        .chatbox("option", "boxManager")
                        .toggleBox();
                }
                else {
                    var name = $("#name").val();
                    var email = $("#email").val();
                    loadChatWindow(name, email);
                }
            });

            $(document).ready(function () {
 
            });
        });

    </script>
</head>
<body>
    <div id="chat_window">
        <div id="chat_title_bar">
            <span class="col-sm-9 text-primary"><strong>Chat with us</strong></span>
            <div id="chat_min_button"><i class="fa fa-plus-square"></i></div>
        </div>
        <div id="chat_box" style="display:none;overflow-y:auto;">
            Name:
            <input id="name" type="text" />
            Email:
            <input id="email" type="text" /><br />
            <input type="button" id="btn" value="Start Chat" />
        </div>
    </div>
    <div id="chat_div">
    </div>
</body>
</html>
